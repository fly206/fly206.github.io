---
title: 使用命令行安装kali最小化系统
author: fly206
date: 2022-03-27 10:28:57.795663+08:00
categories: [Blogging, Linux]
tags: [kalilinux]
math: true
mermaid: true
---

## 使用命令行安装kali最小化系统

### 文件系统格式化及挂载
```sh
mkfs.btrfs /dev/sda4
mkfs.vfat -F32 /dev/sda5
mount /dev/sda4 /mnt
mkdir -p /mnt/boot
mount /dev/sda5 /mnt/boot
```
### 使用debootstrap安装基础系统组件：
```sh
# debootstrap [选项] [开发版代号] [根分区目录] [仓库链接]
debootstrap --arch=amd64 kali-rolling /mnt http://mirrors.ustc.edu.cn/kali
```
### 基础系统配置
#### fatab分区配置，使用genfstab生成挂载信息
```sh
# genfstab [选项] [已挂载的分区] 
# -U 使用UUID代替分区分区名称
# 并重定向到fstab文件
genfstab -U /mnt > /mnt/etc/fstab
```
#### chroot进入系统并配置，这里使用systemd-nspawn
```sh
# 使用-D选项指定目录
systemd-nspawn -D /mnt
```
#### 开始配置系统
```sh
# 设定root密码
passwd

# 修改软件源
nano /etc/apt/sources.list
# 添加中科大源
deb http://mirrors.ustc.edu.cn/kali kali-rolling main non-free contrib
deb-src http://mirrors.ustc.edu.cn/kali kali-rolling main non-free contrib

# 软件更新
apt update && apt upgrade

# 时区配置
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

# 本地化
apt install locales
echo "LANG=en_US.UTF-8" > /etc/locale.conf
dpkg-reconfigure locales
# 配置主机名
echo "kali" > /etc/hostname

# 配置主机名解析
echo -e "127.0.0.1\tkali" >> /etc/hosts

# 安装自己需要的固件文件
apt install kali-linux-firmware firmware-realtek firmware-linux firmware-linux-free firmware-linux-nonfree firmware-iwlwifi firmware-amd-graphics bluez-firmware

# 安装linux内核
apt install linux-image-amd64

# 配置启动文件（由于本人的主系统已有refind,只需要加一个配置文件即可，
# 也可以额外安装grub等启动管理器）
# 在boot分区新建文件
touch /boot/refind_linux.conf
# 添加根分区信息
"Boot with standard options"  "root=UUID=31d828ea-acfc-4391-bbd8-ccdeeb6b6993 rw rootflags=subvol=/ loglevel=5"
"Boot to single-user mode"    "root=UUID=31d828ea-acfc-4391-bbd8-ccdeeb6b6993 rw rootflags=subvol=/ loglevel=5 single"
"Boot with minimal options"   "ro root=/dev/nvme0n1p2"

```
经过以上配置，可以基本正常的启动到新系统了，以下额外配置可以使用chroot的方式配置，也可以在新系统启动后配置
#### 额外配置
```sh
# 使用systemd-nspawn进入新系统
systemd-nspawn -D /mnt -b

# 新建普通用户
adduser fly

# 添加sudo
apt install sudo
# 配置sudoers文件
nano /etc/sudoers
# 添加以下配置
fly     ALL=(ALL:ALL) ALL

# 安装网络管理，这里安装networkmanager网络管理
apt install network-manager

# 安装sway窗口管理器及相关组件
apt install sway grimshot sway-backgrounds swaybg swayidle swayimg waybar wdisplays wofi foot

# 安装xorg的wayland兼容层
apt install xwayland

# 配置profile, 增加sway启动
nano /home/fly/.profile
# 添加以下内容
if [ -z $DISPLAY ] && [ "$(tty)" = "/dev/tty1" ]; then
  exec sway
fi

# 安装网络管理器前端工具
sudo apt install nm-tray nm-tray-l10n

# 安装系统信息查看工具
sudo apt install neofetch

# 安装bash命令行补全工具
sudo apt install bash-completion

# 安装fcitx5输入法
sudo apt install fcitx5  fcitx5-chinese-addons  fcitx5-config-qt

# 输入法配置
sudo nano /etc/environment
# 添加以下内容
GTK_IM_MODULE=fcitx
QT_IM_MODULE=fcitx
XMODIFIERS=@im=fcitx

# 安装网页浏览器
sudo apt install firefox-esr

# 其他软件包随用随装即可
```